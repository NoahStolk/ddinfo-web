using Microsoft.AspNetCore.Rewrite;
using Microsoft.Net.Http.Headers;

namespace DevilDaggersInfo.Web.Server.RewriteRules;

/// <summary>
/// Redirects old spawnset pages from the V4 website. Only the spawnsets that existed at that point are included here (dumped with SQL).
/// </summary>
public class SpawnsetPageRewriteRules : IRule
{
	private static readonly Dictionary<int, string> _names = new()
	{
		{ 1, "DaggerLobby" },
		{ 2, "V1" },
		{ 3, "V2" },
		{ 4, "V3" },
		{ 5, "Calm" },
		{ 6, "SquidOverdose" },
		{ 7, "Stretch" },
		{ 8, "Sushi" },
		{ 9, "V3-1" },
		{ 10, "Gigapedes" },
		{ 11, "Survival456Start" },
		{ 12, "Transmuted1" },
		{ 13, "Transmuted2" },
		{ 14, "Skull4Square" },
		{ 15, "Level3" },
		{ 16, "Invasions" },
		{ 17, "SquidFortress" },
		{ 18, "KingdomOfSpiders" },
		{ 19, "Limit" },
		{ 20, "Speedcore" },
		{ 21, "Ultradonut" },
		{ 22, "V3Dark" },
		{ 23, "V3Half" },
		{ 24, "V4Kappa" },
		{ 25, "ChaosFarmRequired" },
		{ 26, "HowFastCanYouGo" },
		{ 27, "Yes" },
		{ 28, "WhatIf500WasHard" },
		{ 29, "TransmutedLaughingSkulls" },
		{ 30, "NoWay" },
		{ 33, "00312" },
		{ 34, "116110" },
		{ 35, "Darkness" },
		{ 36, "Cage" },
		{ 38, "WhatIf500WasHarder" },
		{ 39, "Wavex" },
		{ 40, "DaggerJumpPracticeMap" },
		{ 41, "Levels" },
		{ 42, "Transmuted3" },
		{ 43, "HellOnSteroids" },
		{ 44, "Donut" },
		{ 45, "V4HahaYes" },
		{ 46, "300SecondsOfHell" },
		{ 47, "HeckingImpossible" },
		{ 48, "ImpossibleSquids" },
		{ 49, "NUMERAL_FIELD" },
		{ 50, "AllGems" },
		{ 51, "bintrs cool spawnset" },
		{ 53, "Centipedes Gon' KILL U" },
		{ 54, "Endgame Loop" },
		{ 55, "Fallen" },
		{ 56, "Ghostpede Sesh" },
		{ 57, "Spiral Platforms" },
		{ 58, "What a nightmare" },
		{ 59, "Bosswave after wave" },
		{ 60, "Platforms 'n' Ring" },
		{ 61, "AimPracticeMap" },
		{ 62, "AttackAttackAttack" },
		{ 63, "A little bit of hell" },
		{ 64, "Crystalise" },
		{ 65, "Demonfest" },
		{ 66, "Instant Calamity" },
		{ 67, "Instant Catastrophe" },
		{ 68, "Quite the challenge" },
		{ 69, "Spider pit" },
		{ 70, "Spiders making life difficult" },
		{ 71, "Super Practice" },
		{ 72, "The Inner Sanctum" },
		{ 73, "V3 but it really isn't" },
		{ 74, "V3 but somewhat different" },
		{ 75, "V3 no Levi" },
		{ 76, "Wave 22" },
		{ 77, "Wave 22 (Lv3)" },
		{ 78, "Wave 22 (Lv4)" },
		{ 79, "redring" },
		{ 80, "TheOrb" },
		{ 81, "DeepestFears" },
		{ 82, "calamari_tuesday" },
		{ 83, "WhiteDeath" },
		{ 84, "HardCage" },
		{ 85, "bug_problem" },
		{ 86, "ToTheTop" },
		{ 87, "Endloop (Ghostpedeless) 300Homing" },
		{ 88, "Endloop (Ghostpedeless) - 30 waves" },
		{ 89, "Escalates quickly" },
		{ 90, "Screaming" },
		{ 91, "Screaming a bit less" },
		{ 92, "Navigating the Hellfields" },
		{ 93, "V3 but Levi is at the start" },
		{ 94, "Screaming intensifies" },
		{ 95, "lennyface arena" },
		{ 96, "lennyface arena (alternative)" },
		{ 97, "An Experiment (666 Homing)" },
		{ 98, "An Experiment (400 Homing)" },
		{ 99, "An Experiment (850 Homing)" },
		{ 100, "Endloop (Ghostpedeless) - 10 waves" },
		{ 101, "Endloop (Ghostpedeless) - 20 waves" },
		{ 102, "Archfiend Amphitheatre" },
		{ 103, "Helfen mir" },
		{ 104, "What do you mean, easy" },
		{ 105, "Screaming but with gigas" },
		{ 106, "TheLongestYard" },
		{ 107, "ez_mode" },
		{ 108, "NoSpaceInHell" },
		{ 109, "pond" },
		{ 110, "Trap" },
		{ 111, "Utterly Mad" },
		{ 112, "The Marathon" },
		{ 113, "Ridiculous Marathon" },
		{ 114, "candlelight" },
		{ 115, "xvlv_is_a_nice_person" },
		{ 116, "Absolutely Ridiculous Marathon" },
		{ 117, "Triplets" },
		{ 118, "Plunging" },
		{ 119, "Crescendo" },
		{ 120, "Rings" },
		{ 121, "Synchronous Simultaneous Summons" },
		{ 122, "The Playground" },
		{ 123, "Floods" },
		{ 124, "Leap" },
		{ 125, "Minutely Massacres {harrowingly hard}" },
		{ 126, "Minutely Massacres [decent difficulty]" },
		{ 127, "Minutely Massacres (exceedingly easier)" },
		{ 128, "oh NO" },
		{ 129, "Merciful Marathon" },
		{ 130, "feed" },
		{ 131, "slice" },
		{ 132, "A Race Against Time" },
		{ 133, "immortal_hole" },
		{ 134, "Squid II Spree" },
		{ 135, "Beyblade" },
		{ 136, "infinity_farm" },
		{ 137, "ddbutithappensallatonce" },
		{ 138, "calcium" },
		{ 139, "etherealuprising" },
		{ 140, "airstrip69" },
		{ 141, "ez_mode2" },
		{ 142, "CellMates" },
		{ 143, "V3 1.33x faster" },
		{ 144, "A Predicament" },
		{ 145, "Abominable Assault" },
		{ 146, "Clock of Death" },
		{ 147, "Intense" },
		{ 148, "Watch your step" },
		{ 149, "You Must Be Joking" },
		{ 150, "Peril" },
		{ 151, "rings_of_power" },
		{ 152, "Bloody Hell" },
		{ 153, "vacation" },
		{ 154, "evolv3loop" },
		{ 155, "Easier said than done" },
		{ 156, "Chasms" },
		{ 157, "Overkill" },
		{ 158, "Alternating Anarchy" },
		{ 159, "Mini Platforms" },
		{ 160, "Obstacle Course (long)" },
		{ 161, "Obstacle Course" },
		{ 162, "The Dark Lord's Demons" },
		{ 163, "Vermin" },
		{ 164, "Writhing and Crawling" },
		{ 165, "Chrysanthemum" },
		{ 166, "Clutch" },
		{ 167, "Lotsa Leviathans" },
		{ 168, "MySweetThorns" },
		{ 169, "Special Snowflake" },
		{ 170, "V3Overgrowth" },
		{ 171, "recurring_nightmare" },
		{ 172, "V3Leviathan" },
		{ 173, "BoxOfSpiders" },
		{ 174, "LadderOfMadness" },
		{ 175, "Waves" },
		{ 176, "V3TruePrismEasy" },
		{ 177, "V3TruePrismMed" },
		{ 178, "V3TruePrismHard" },
		{ 179, "V^3" },
		{ 180, "creeps" },
		{ 181, "RHZ" },
		{ 182, "Disgusting" },
		{ 183, "Try Again" },
		{ 184, "Blitz" },
		{ 185, "microspawn" },
		{ 186, "nulls_V3" },
		{ 187, "Panic" },
		{ 188, "Gigapedey Waves" },
		{ 189, "Panic!" },
		{ 190, "Simple Loop" },
		{ 191, "Endure" },
		{ 192, "Panic Stations" },
		{ 193, "V3 for Lunatics" },
		{ 194, "spaghetti-o" },
		{ 195, "v5" },
		{ 196, "Stockpile" },
		{ 197, "Endloopception" },
		{ 198, "Gem Hunting" },
		{ 199, "Turbocharged V3" },
		{ 200, "Stockpile (Evil Endloop)" },
		{ 201, "MadMap" },
		{ 202, "Surge" },
		{ 203, "Aim_Training" },
		{ 204, "TheFourLeviathanOfTheApocalypse" },
		{ 205, "FourDigitSkullSplitter" },
		{ 206, "Coil" },
		{ 207, "TwoDigitSkullSplitter" },
		{ 208, "bigplate" },
		{ 209, "Intimidate" },
		{ 210, "Aztec Arena" },
		{ 211, "Smoke" },
		{ 212, "InnerDescent" },
		{ 213, "Kill" },
		{ 214, "crimson_gauntlet" },
		{ 215, "airstrip70" },
		{ 216, "PrettyHard" },
		{ 217, "Skip first 3 minutes" },
		{ 218, "Delirium" },
		{ 219, "Rush" },
		{ 221, "littleplate" },
		{ 222, "Braniac (You Suck At Dagger Jumps)" },
		{ 223, "succ" },
		{ 224, "Braniac - For Smooth Brains" },
		{ 226, "pileup" },
		{ 227, "AttackAttackAttack2" },
		{ 228, "Sixtreme" },
		{ 230, "YouMustFearTheDark" },
		{ 232, "BradensNiftySpawnset" },
		{ 233, "Satanica Sacra" },
		{ 234, "uh_oh" },
		{ 235, "25GemsGigapedes" },
		{ 236, "waitnostop" },
		{ 237, "nohoming" },
		{ 238, "spikes" },
		{ 239, "RetardedV4" },
		{ 240, "CentipedeHell" },
		{ 241, "Level2CentiScrapePractice" },
		{ 242, "Black Death" },
		{ 243, "bossfight" },
		{ 244, "Void" },
		{ 245, "Regretti" },
		{ 246, "Terror" },
		{ 247, "Struggle" },
		{ 248, "Triple Lev" },
		{ 249, "0_0" },
		{ 250, "Help" },
		{ 251, "Onslaught" },
		{ 252, "nanospawn" },
		{ 253, "Frenzy" },
		{ 254, "Potent" },
		{ 255, "TooManySkulls" },
		{ 256, "Feast" },
		{ 257, "permute2" },
		{ 258, "Bloodlust" },
		{ 259, "FluidMovment" },
		{ 260, "Zoo" },
		{ 261, "OCD" },
		{ 262, "2Spooky4Me" },
		{ 263, "Carnage" },
		{ 264, "8-chamber" },
		{ 265, "snakes-and-ladders" },
		{ 266, "abyss" },
		{ 267, "dont_die_the_stretch_V2" },
		{ 268, "metathrone_preview1" },
		{ 269, "Loopy" },
		{ 270, "Bonk" },
		{ 271, "survival_just_levi" },
		{ 272, "hell_wants_you_back" },
		{ 278, "andheretheycome" },
		{ 279, "annoys_me_to_no_end" },
		{ 280, "Ghostbusters" },
		{ 281, "FastestCentipedeKill" },
		{ 282, "FastestSquidIIIKill" },
		{ 283, "FastestSquidIIKill" },
		{ 284, "FastestSquidIKill" },
		{ 285, "FastestSpiderIKill" },
		{ 286, "FastestThornKill" },
		{ 287, "FastestGigapedeKill" },
		{ 288, "Transmuted4" },
		{ 289, "donut_die" },
		{ 290, "TooMuchSushi" },
		{ 291, "obstacle_course" },
		{ 296, "V3NoFarm_49" },
		{ 297, "V3NoFarm_134" },
		{ 298, "V3NoFarm_184" },
		{ 299, "V3NoFarm_229" },
		{ 300, "V3NoFarm_259" },
		{ 301, "V3NoFarm_350" },
		{ 302, "V3NoFarm_397" },
		{ 303, "V3NoFarm_440" },
		{ 304, "V3Level4_451 (wave 1)" },
		{ 305, "V3 10x faster" },
		{ 306, "Bradens_Gauntlet" },
		{ 307, "ikayaki" },
		{ 308, "V3Level4_507 (wave 2)" },
		{ 309, "V3Level4_557 (wave 3)" },
		{ 310, "V3Level4_602 (wave 4)" },
		{ 311, "V3Level4_642 (wave 5)" },
		{ 312, "V3Level4_680 (wave 6)" },
		{ 313, "V3Level4_714 (wave 7)" },
		{ 314, "V3Level4_746 (wave 8)" },
		{ 315, "V3Level4_776 (wave 9)" },
		{ 316, "V3Level4_804 (wave 10)" },
		{ 317, "V3Level4_830 (wave 11)" },
		{ 318, "V3Level4_855 (wave 12)" },
		{ 319, "V3Level4_879 (wave 13)" },
		{ 320, "V3Level4_901 (wave 14)" },
		{ 321, "V3Level4_923 (wave 15)" },
		{ 322, "V3Level4_943 (wave 16)" },
		{ 323, "V3Level4_962 (wave 17)" },
		{ 324, "V3Level4_981 (wave 18)" },
		{ 325, "V3Level4_999 (wave 19)" },
		{ 326, "V3Level4_1016 (wave 20)" },
		{ 327, "V3Level4_1033 (wave 21)" },
		{ 328, "V3Level4_1049 (wave 22)" },
		{ 329, "V3Level4_1064 (wave 23)" },
		{ 330, "V3Level4_1079 (wave 24)" },
		{ 331, "V3Level4_1094 (wave 25)" },
		{ 332, "V3Level4_1108 (wave 26)" },
		{ 333, "V3Level4_1121 (wave 27)" },
		{ 334, "V3Level4_1134 (wave 28)" },
		{ 335, "V3Level4_1147 (wave 29)" },
		{ 336, "V3Level4_1160 (wave 30)" },
		{ 337, "V3Level4_1172 (wave 31)" },
		{ 338, "V3Level4_1184 (wave 32)" },
		{ 339, "V3Level4_1195 (wave 33)" },
		{ 340, "V3Level4_1206 (wave 34)" },
		{ 341, "V3Level4_1217 (wave 35)" },
		{ 342, "V3Level4_1228 (wave 36)" },
		{ 343, "V3Level4_1238 (wave 37)" },
		{ 344, "V3Level4_1249 (wave 38)" },
		{ 345, "Volatile" },
		{ 346, "Inverse Loop" },
		{ 348, "v1.33x_LOOP_ONL" },
		{ 349, "TransmutedBonk" },
		{ 350, "DefendDefendDefend" },
		{ 351, "DefendDefendDefend2" },
		{ 352, "V0" },
		{ 355, "Scanner" },
		{ 356, "TinySpeedrun1" },
		{ 357, "TinySpeedrun2" },
		{ 358, "crumblecade" },
		{ 359, "AttackAttackAttackCentipede" },
		{ 360, "hellish_loop" },
		{ 363, "exopalace" },
		{ 364, "KingdomOfSpiders2" },
		{ 365, "YouMustFearTheDark2" },
		{ 366, "HorribleTrollSpawnset" },
		{ 367, "No Homo Leviathan" },
		{ 368, "V3-but-youre-stuck-with-level-1" },
		{ 370, "V3-but-youre-stuck-with-level-3" },
		{ 371, "V3-but-youre-stuck-with-level-4" },
		{ 372, "TinySpeedrun3" },
		{ 373, "TinySpeedrun2ButTheWallsAreHigher" },
		{ 374, "SmallSpeedrunButItsReallyBad" },
		{ 375, "Level2CentiScrapePracticeImproved" },
		{ 376, "TinyJumps1" },
		{ 377, "No Homo Giga Trio Level 3" },
		{ 378, "deathway" },
		{ 379, "jetway" },
		{ 380, "AttackAttackGigapede" },
		{ 381, "Panic_V2" },
		{ 382, "Blender" },
		{ 383, "Get_Out" },
		{ 384, "Rush_V2" },
		{ 385, "V3 doubled" },
		{ 386, "V3 doubled (loop only)" },
		{ 387, "V3 doubled (balanced)" },
		{ 388, "Thorns and a side of Pedes" },
		{ 389, "HowFastCanYouGoCenti" },
		{ 390, "powercase" },
		{ 391, "kikenthar" },
		{ 392, "SquidHellPrac" },
		{ 393, "PlatinumPlatPlatener" },
		{ 394, "Speeeeeeeed" },
		{ 395, "Warm_up" },
		{ 396, "HardCore" },
		{ 397, "HardCore_lite" },
		{ 398, "Oh lord They comin" },
		{ 399, "SquidHell" },
		{ 400, "tech-warmup" },
		{ 401, "SpeedV2" },
		{ 402, "Limbo" },
		{ 404, "Lust" },
		{ 405, "Gluttony" },
		{ 406, "Greed" },
		{ 407, "mokuton" },
		{ 408, "Pedeslayer" },
		{ 409, "skyway" },
		{ 410, "up" },
		{ 411, "noodle_soup" },
		{ 412, "AngerOld" },
		{ 413, "exostate" },
		{ 414, "Heresy" },
		{ 415, "Anger" },
		{ 416, "chappie" },
		{ 417, "CrosshairMaze" },
		{ 418, "confetti" },
		{ 419, "metathrone" },
		{ 420, "Jump Knight" },
		{ 421, "Dont_Fall" },
		{ 422, "RoundnRound" },
		{ 423, "Fast_loop" },
		{ 424, "No Homo 680" },
		{ 425, "yolandi v2" },
		{ 426, "yolandi v1" },
		{ 427, "TinyTowerOfShit" },
	};

	private static readonly Dictionary<int, string> _escapedNames = _names.ToDictionary(kvp => kvp.Key, kvp => Uri.EscapeDataString(kvp.Value));

	public void ApplyRule(RewriteContext context)
	{
		HttpRequest request = context.HttpContext.Request;
		if (request.Path.Value == null || request.QueryString.Value == null || RewriteRuleUtils.EndsWithContent(request.Path.Value))
			return;

		if (!request.Path.Value.Equals("/Spawnset", StringComparison.OrdinalIgnoreCase))
			return;

		const string queryStringKey = "?spawnset=";
		if (!request.QueryString.Value.StartsWith(queryStringKey, StringComparison.OrdinalIgnoreCase))
			return;

		string spawnsetName = request.QueryString.Value.TrimStart(queryStringKey);
		int? spawnsetId = _escapedNames.ContainsValue(spawnsetName) ? _escapedNames.First(kvp => kvp.Value == spawnsetName).Key : null;
		if (!spawnsetId.HasValue)
			return;

		context.Result = RuleResult.EndResponse;

		context.HttpContext.Response.StatusCode = StatusCodes.Status301MovedPermanently;
		context.HttpContext.Response.Headers[HeaderNames.Location] = $"{request.Scheme}://{request.Host}/custom/spawnset/{spawnsetId.Value}";
	}
}
